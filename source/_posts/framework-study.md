---
title: Android framework层学习笔记
author: 寒雨
hide: false
categories: 笔记
tags:
  - Android
  - framework层
---

# Android framework层学习笔记

## 零碎的Q & A

> 为什么SystemService(AMS)进程与Zygote进程通信不使用Binder而使用Socket?

因为Zygote进程的fork操作仅允许在单线程下进行，而Binder之所以高性能的部分原因是因为它是多线程的。

> 为什么Zygote只能在单线程下fork

先来看看Zygote fork进程的工作原理

> 1. 父进程的内存数据会原封不动的拷贝到子进程中（copy-on-write策略 -> 复制时内核并不复制整个进程的地址空间，而是让父子进程共享同一个地址空间。只用在需要写入的时候才会复制地址空间，从而使各个进行拥有各自的地址空间。也就是说，资源的复制是在需 要写入的时候才会进行，在此之前，只有以只读方式共享）
> 2. **子进程在单线程状态下被生成**

注意第二句话，也就是说被fork出来的进程只会带有一条线程，无论父进程有几条线程

而上面我们说过了，Binder是基于多线程操作的。设想如果我们使用Binder来进行fork操作，会发生什么状况：

> 如果一个Binder进程有锁，那么其拷贝的子进程上的主线程也会存在锁，子进程等待其子线程的资源来释放其拥有的锁，然而其父进程的子线程并不会拷贝过来，因为根据fork的工作，它的子进程只会被生成单线程，而这样一来就会造成死锁，为了解决这个问题fork就不允许存在多线程，所有Zygote也就不再使用Binder进程了。

这里我有个疑问，如果是不存在锁的多线程呢？这里的解释是因为会导致死锁而不使用多线程，如果压根就没有使用锁呢？
